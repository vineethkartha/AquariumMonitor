<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Temperature Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Temperature Readings</h2>

    <label for="quickRange">Quick Range: </label>
    <select id="quickRange">
        <option value="">--Select--</option>
        <option value="today">Today</option>
        <option value="1week">Last 1 Week</option>
        <option value="1month">Last 1 Month</option>
        <option value="6months">Last 6 Months</option>
        <option value="1year">Last 1 Year</option>
        <option value="ytd">Year to Date</option>
    </select>
    <style>
      /* Spinner animation */
      @keyframes spin {
	  0% { transform: rotate(0deg); }
	  100% { transform: rotate(360deg); }
      }
      
      /* Container for chart & spinner */
      #chartContainer {
	  position: relative;
	  width: 900px;  /* match your canvas width */
	  height: 400px; /* match your canvas height */
      }
      
      /* Overlay spinner */
      #loadingSpinnerOverlay {
	  display: none;
	  position: absolute;
	  top: 0; left: 0;
	  width: 100%; height: 100%;
	  background: rgba(255, 255, 255, 0.7); /* semi-transparent white */
	  z-index: 10;
	  display: flex;
	  justify-content: center;
	  align-items: center;
      }
      
      #loadingSpinnerOverlay div.spinner {
	  border: 6px solid #f3f3f3;
	  border-top: 6px solid #3498db;
	  border-radius: 50%;
	  width: 36px;
	  height: 36px;
	  animation: spin 1s linear infinite;
      }
    </style>
    
    <div id="chartContainer">
      <canvas id="temperatureChart" width="900" height="400"></canvas>
      <div id="loadingSpinnerOverlay">
	<div class="spinner"></div>
      </div>
    </div>
    
    <script>
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        let temperatureChart;

        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${date.getFullYear()}-${month}-${day}`;
        }

      function loadChartData(startDate, endDate) {
	  const spinnerOverlay = document.getElementById('loadingSpinnerOverlay');
	  spinnerOverlay.style.display = 'flex'; // Show overlay spinner

          fetch(`/temperature_chart_data?start_date=${startDate}&end_date=${endDate}`)
              .then(response => response.json())
              .then(data => {
		  spinnerOverlay.style.display = 'none'; // Hide overlay spinner
                  if (!Array.isArray(data) || data.length === 0) {
                      alert("No data available for this range.");
                      return;
                  }
		  
                  const labels = data.map(entry => entry.timestamp);
                  const temperatures = data.map(entry => entry.temperature);
		  
                  const minTemp = Math.min(...temperatures);
                  const maxTemp = Math.max(...temperatures);
                  const avgTemp = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
		  
                  const pointColors = temperatures.map(temp =>
						       temp === minTemp ? 'blue' :
						       temp === maxTemp ? 'red' :
						       'rgba(75, 192, 192, 1)'
						      );
		  
                  const pointSizes = temperatures.map(temp =>
						      (temp === minTemp || temp === maxTemp) ? 6 : 2
						     );
		  
                  const chartData = {
                      labels: labels,
                      datasets: [
                          {
                              label: 'Temperature (°C)',
                              data: temperatures,
                              borderColor: 'rgba(75, 192, 192, 1)',
                              pointBackgroundColor: pointColors,
                              pointRadius: pointSizes,
                              fill: false,
                              tension: 0.5
                          },
                          {
                              label: `Average (${avgTemp.toFixed(1)}°C)`,
                              data: Array(temperatures.length).fill(avgTemp),
                              borderColor: 'rgba(255, 205, 86, 0.8)',
                              borderDash: [6, 6],
                              pointRadius: 0,
                              fill: false
                          }
                      ]
                  };
		  
                  const chartOptions = {
                      responsive: true,
                      scales: {
                          x: {
                              title: { display: true, text: 'Date & Time' },
                              ticks: { maxRotation: 60, minRotation: 45 }
                          },
                          y: {
                              title: { display: true, text: 'Temperature (°C)' },
                              min: Math.floor(minTemp * 10) / 10 - 0.2,
                              max: Math.ceil(maxTemp * 10) / 10 + 0.2,
                              ticks: { stepSize: 0.1 }
                          }
                      }
                  };
		  
                  if (temperatureChart) {
                      temperatureChart.destroy();
                  }
		  
                  temperatureChart = new Chart(ctx, {
                      type: 'line',
                      data: chartData,
                      options: chartOptions
                  });
              })
	      .catch(error => {
		  spinnerOverlay.style.display = 'none'; // Hide overlay spinner
		  console.error('Fetch error:', error);
		  alert("Failed to load data.");
              });
      }
      
      document.getElementById('quickRange').addEventListener('change', function () {
          const today = new Date();
          let startDate, endDate = today;
	  
          switch (this.value) {
          case 'today':
              startDate = today;
              break;
          case '1week':
              startDate = new Date(today);
              startDate.setDate(today.getDate() - 7);
                    break;
          case '1month':
              startDate = new Date(today);
              startDate.setMonth(today.getMonth() - 1);
              break;
          case '6months':
              startDate = new Date(today);
              startDate.setMonth(today.getMonth() - 6);
              break;
                case '1year':
                    startDate = new Date(today);
              startDate.setFullYear(today.getFullYear() - 1);
              break;
          case 'ytd':
              startDate = new Date(today.getFullYear(), 0, 1);
              break;
          default:
              return;
          }
	  
          loadChartData(formatDate(startDate), formatDate(endDate));
      });
      
      // Optional: auto-load "Last 1 Week" on first page load
      window.addEventListener('DOMContentLoaded', () => {
          document.getElementById('quickRange').value = '1week';
          document.getElementById('quickRange').dispatchEvent(new Event('change'));
      });
    </script>
</body>
</html>
